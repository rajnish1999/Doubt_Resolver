<%- include('partials/header.ejs') %>
<div class="outerMostDiv">
    <div class="askQuesDiv">
        <h1 class="heading_question">Ask your doubt!!</h1>
        <form method="POST" action="/addQuestion" class="question_form">
            <textarea name="qt" type="text" id="quesInput" ></textarea>
            <button class="ques_button" type="submit">Add Question</button>
        </form>
    </div>

    
    <% for(let i=0;i< questionArr.length;i++) { %>
        <div class="outerDivForQuestions">
            <div class="divShowingQuestion">
                <h1><%= questionArr[i].description %></h1>
                <div class="questionOptions">
                    <div class="upAndDownVote">
                        <button class="buttonForUp"><i class="fal fa-thumbs-up fa-2x"></i></button>
                        <button class="buttonForDown"><i class="fal fa-thumbs-down fa-2x"></i></button>
                    </div>
                    <button id="answerToggle-<%= i %>" onClick="toggleAnswer('<%= i %>')">Answers</button>
                </div>
            </div>
            
            <form method="POST" action="/addAnswer" class="divToWriteAns">
                <textarea name="ans" type="text" class="ansInput" rows="1" placeholder="Add an answer..."></textarea>
                <button  class="ans_button" type="submit">Add Answer</button>
                <input type="hidden" name="question" value="<%= questionArr[i]._id %>" />
            </form>

            <div class="seeAllAns" id="seeAllAns-<%= i %>" style="display:none">
                
                <% for(let j=0;j< answerArr.length;j++) { %>
                    <% if(answerArr[j].question.toString() === questionArr[i]._id.toString()) {%>   
                        <div class="divShowingAnswer">
                            <div class="userInfo">
                                <div class="userDP">
                                    <img src="http://localhost:5000/profile/avatar/<%= answerArr[j].creator._id %>" alt="" class="userImage">
                                </div>
                                <div class="nameAndDate">
                                    <div class="userNameAnswer"><%= answerArr[j].creator.username %></div>
                                    <div class="userDateAnswer">
                                        <%= answerArr[j].dateAndTime%>
                                    </div>
                                </div>
                            </div>
                            <h2><%= answerArr[j].answerText %></h2>
                            <div class="answerOptions">
                                <div class="upAndDownVote">
                                    <button class="buttonForUp"><i class="fal fa-thumbs-up fa-2x"></i></button>
                                    <button class="buttonForDown"><i class="fal fa-thumbs-down fa-2x"></i></button>
                                </div>
                                <button id="commentToggle-<%= j %>" onClick="toggleComment('<%= j %>')">Comments</button>
                            </div>
                        </div>

                        <form method="POST" action="/addComment" class="divToWriteComment">
                            <textarea name="comment" type="text" class="commentInput" rows="1" placeholder="Add a comment..."></textarea>
                            <button  class="comment_button" type="submit">Add Comment</button>
                            <input type="hidden" name="question" value="<%= questionArr[i]._id %>" />
                            <input type="hidden" name="answer" value="<%= answerArr[j]._id %>" />
                        </form>
                        <div id="seeAllComment-<%= j %>" style="display:none">
                
                            <% for(let k=0;k< commentArr.length;k++) { %>
                                <% if(typeof commentArr[k].answer != 'undefined' && commentArr[k].answer.toString() === answerArr[j]._id.toString()) {%>   
                                    <div class="divShowingComment" id="<%= commentArr[k]._id %>">
                                        <div class="userInfo">
                                            <div class="userDP">
                                                <img src="http://localhost:5000/profile/avatar/<%= commentArr[k].creator._id %>" alt="" class="userImageComment">
                                            </div>
                                            <div class="nameAndDate">
                                                <div class="userNameComment"><%= answerArr[j].creator.username %></div>
                                                <div class="userDateComment"><%= commentArr[k].dateAndTime%></div>
                                            </div>
                                        </div>
                                        <h2><%= commentArr[k].commentText %></h2>
                                        <div class="commentOptions">
                                            <div class="upAndDownVote">
                                                <button class="buttonForUp"><i class="fal fa-thumbs-up fa-2x"></i></button>
                                                <button class="buttonForDown"><i class="fal fa-thumbs-down fa-2x"></i></button>
                                                <button 
                                                    onClick="toggleAddSubComment('<%= commentArr[k]._id %>')"
                                                    >
                                                    <i class="fal fa-reply fa-2x"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <form method="POST" action="/addComment" id="nestedCom-<%= commentArr[k]._id %>"  class="divToWriteSubComment">
                                            <textarea name="comment" type="text" class="commentInput" rows="1" placeholder="Add a comment..."></textarea>
                                            <button  class="comment_button" type="submit">Add Comment</button>
                                            <input type="hidden" name="parent" value="<%= answerArr[j]._id %>" />
                                        </form>
                                    </div>
                                <% } %>
                            <% } %>
                            
                        </div>
                    <% } %>
                <% } %>
                
            </div>
        </div>
    <% } %>
</div>

<script>
    const toggleAnswer = (i) => {
        const ansOfQ = document.getElementById(`seeAllAns-${i}`);

        if(ansOfQ.style.display === 'none'){
            ansOfQ.style.display = 'block'
        }else{
            ansOfQ.style.display = 'none'
        }
    }

    const toggleComment = (j) => {
        const commentOfAns = document.getElementById(`seeAllComment-${j}`);
        
        if(commentOfAns.style.display === 'none'){
            commentOfAns.style.display = 'block'
        }else{
            commentOfAns.style.display = 'none'
        }
    }

   const toggleAddSubComment = (id) => {
       const subComOfCom = document.getElementById(`nestedCom-${id}`);

       if(subComOfCom.style.display == 'none'){
           subComOfCom.style.display = 'flex'
       }else{
           subComOfCom.style.display = 'none'
       }
   }

    
    let tempComment = '<%- JSON.stringify(commentArr) %>'
    // let tempAnswer = '<%- JSON.stringify(commentArr) %>'
    let arrComment = JSON.parse(tempComment);
    let newCommentArr = arrComment.filter((comment) => typeof comment.answer == 'undefined')

    console.log(newCommentArr);

    // let arrAnswer = JSON.parse(tempAnswer);

    const addNestedCom = (obj) => {
        const parsedObj = obj;
        const queue = [];
        queue.push(parsedObj);
        let k = 0;
        while(queue.length > 0) {
            let tempEle = queue.shift();
            if(k > 0){

                let formForSubComment = document.createElement("form");
                let textareaForSubComment = document.createElement("textarea");
                let submitForSubComment = document.createElement("button");
                let inputForParentSubComment = document.createElement("input");

                formForSubComment.appendChild(textareaForSubComment);
                formForSubComment.appendChild(submitForSubComment);
                formForSubComment.appendChild(inputForParentSubComment);
                
                formForSubComment.setAttribute("action", "/addComment");
                formForSubComment.setAttribute("method", "POST");
                formForSubComment.className = "divToWriteSubComment"
                formForSubComment.setAttribute("id",`nestedCom-${tempEle._id}`)
                textareaForSubComment.setAttribute("name", "comment");
                textareaForSubComment.setAttribute("type", "text");
                textareaForSubComment.setAttribute("rows", "1");
                textareaForSubComment.setAttribute("placeholder", "Add a comment...");
                textareaForSubComment.className = "commentInput";
                submitForSubComment.setAttribute("type", "submit");
                submitForSubComment.className = "comment_button"
                submitForSubComment.innerHTML = "Add Comment";
                inputForParentSubComment.setAttribute("type", "hidden");
                inputForParentSubComment.setAttribute("name", "parent");
                inputForParentSubComment.setAttribute("value", `${tempEle._id}`);
                
                // below is the options part
                let outerDivForSubCommentOptions = document.createElement('div');
                let optionsOfSubComponents = document.createElement('div');
                let newButtonForUp = document.createElement('button');
                let newButtonForDown = document.createElement('button');
                let newButtonForReply = document.createElement('button');
                let newIForUp = document.createElement('i');
                let newIForDown = document.createElement('i');
                let newIForReply = document.createElement('i');

                outerDivForSubCommentOptions.appendChild(optionsOfSubComponents);
                optionsOfSubComponents.appendChild(newButtonForUp);
                optionsOfSubComponents.appendChild(newButtonForDown);
                optionsOfSubComponents.appendChild(newButtonForReply);
                newButtonForUp.appendChild(newIForUp);
                newButtonForDown.appendChild(newIForDown);
                newButtonForReply.appendChild(newIForReply);

                outerDivForSubCommentOptions.className = "subCommentOptions"
                optionsOfSubComponents.className = "upAndDownVote";
                newButtonForUp.className = "buttonForUp"
                newButtonForDown.className = "buttonForDown"
                newButtonForReply.addEventListener('click', function(e) {
                    toggleAddSubComment(`${tempEle._id}`)
                })
                newIForUp.className = "fal fa-thumbs-up fa-2x";
                newIForDown.className = "fal fa-thumbs-down fa-2x";
                newIForReply.className = "fal fa-reply fa-2x";

                // below is the user info part
                let newOuterDivForUserDetail = document.createElement("div");
                let newDivForUserDP = document.createElement("div");
                let newDivForDateAndName = document.createElement("div");
                let newDivForName = document.createElement("div");
                let newDivForDate = document.createElement("div");
                let imageTagForUser = document.createElement("img");

                newDivForUserDP.appendChild(imageTagForUser);
                newDivForDateAndName.appendChild(newDivForName);
                newDivForDateAndName.appendChild(newDivForDate);
                newOuterDivForUserDetail.appendChild(newDivForUserDP)
                newOuterDivForUserDetail.appendChild(newDivForDateAndName)

                newOuterDivForUserDetail.className = "userInfo";
                newDivForUserDP.className = "userDP";
                newDivForDateAndName.className = "nameAndDate";
                
                newDivForName.className = "userNameComment";
                newDivForDate.className = "userDateComment"
                imageTagForUser.src = `http://localhost:5000/profile/avatar/${tempEle.creator._id}`;
                imageTagForUser.className = "userImageComment";

                newDivForName.innerHTML = `${tempEle.creator.username}`;
                newDivForDate.innerHTML = `${tempEle.dateAndTime}`
                
                //final part, where final div is constructed adding all children together
                let newEle= document.createElement("div")
                let newComEle= document.createElement("div")
                newComEle.innerHTML = tempEle.commentText;
                newComEle.style.cssText="margin: 1em 0;"
                newEle.appendChild(newOuterDivForUserDetail);
                newEle.appendChild(newComEle);
                newEle.appendChild(outerDivForSubCommentOptions);
                newEle.appendChild(formForSubComment);
                newEle.setAttribute("id",`${tempEle._id}`)
                newEle.style.cssText="padding: 1em;border-left: 2px solid #dee0e1;margin-left:1em"
                let parentEle = document.getElementById(`${tempEle.parentComment}`)
                parentEle.appendChild(newEle)
            }
            newCommentArr.forEach((comment) => {
                console.log(comment)
                if(comment.parentComment == tempEle._id){
                    queue.push(comment);
                }
            })
            k++;
        }
    }
    arrComment.forEach((comment) => {
        if(typeof comment.answer != 'undefined'){
            addNestedCom(comment)
        }
    })

</script>

<%- include('partials/footer.ejs') %>
